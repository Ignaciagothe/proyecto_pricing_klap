# Copilot Instructions for Pricing Klap Project

## Project Overview

This is a **payment processor pricing analytics pipeline** with a Streamlit dashboard for merchant segmentation, margin modeling, and competitive pricing analysis. The system processes transaction data from Chilean payment terminals to generate actionable pricing strategies.

## Architecture & Data Flow

### Core Pipeline (Jupyter → Parquet → Streamlit)

1. **`pricing_22_10.ipynb`**: Main analytical notebook that performs EDA, feature engineering, margin calculation, and clustering
2. **`data/processed/`**: Generated Parquet files (gitignored) containing model outputs
3. **`app/streamlit_app.py`**: Interactive dashboard consuming the Parquet files

### Key Data Outputs (in `data/processed/`)

- `merchant_pricing_feature_base.parquet`: Merchant behavioral features and cost metrics
- `merchant_pricing_model_results.parquet`: Final model with margins, competitive gaps, suggested actions, and cluster labels

## Critical Concepts

### Domain-Specific Terminology

- **MDR**: Merchant Discount Rate (percentage fee on transaction volume)
- **Interchange**: Base cost paid to card networks (Visa/Mastercard)
- **Gap pricing**: Competitive differential vs. Transbank benchmark
- **Klap**: The payment processor company
- **Terminal states**: ACTIVO, STOCK, BAJA (operational status)

### Merchant Segmentation Strategy

The model creates **cluster-based archetypes**:

- "Alta contribución": High-value active merchants
- "Brecha competitiva": At-risk due to high pricing vs competitors  
- "Margen en riesgo": Negative/low margin merchants
- "Baja actividad": Inactive terminals needing reactivation
- "Optimización gradual": Stable merchants with optimization potential
- "Sin ventas": Zero-transaction merchants

### Action Framework

`accion_sugerida` field drives business decisions:

- **Reactivación**: For inactive terminals
- **Ajuste urgente**: Negative margins requiring immediate attention
- **Revisión competitiva**: High competitive gap (>0.15pp)
- **Monitoreo**: Low activity requiring tracking
- **Mantener/up-sell**: Healthy merchants for growth

## Developer Workflows

### Running the Full Pipeline

```bash
# 1. Execute main notebook (generates Parquet files)
jupyter notebook pricing_22_10.ipynb
# Run all cells to generate data/processed/*.parquet

# 2. Launch Streamlit dashboard
cd app
streamlit run streamlit_app.py
```

### Working with Data

- **Input data**: Raw CSV/Excel files in `data/` (gitignored, not versioned)
- **Outputs**: Parquet files in `data/processed/` (gitignored, generated by notebook)
- **Streamlit**: Loads from `data/processed/` by default, supports file upload as fallback

### Dependencies

- **Notebook**: `pandas`, `numpy`, `scikit-learn` for analytics
- **Streamlit**: Minimal stack defined in `app/requirements.txt`
- **Virtual env**: Use `app/.venv_pricing/` for the Streamlit app

## Code Patterns

### Data Loading Convention

```python
# Notebook pattern for file paths
DATA_DIR = Path("data")
INTERCHANGE_FILE = DATA_DIR / "Tasa_Intercambio_Chile_Visa_y_Mastercard.csv"

# Streamlit pattern with fallbacks
BASE_DIR = Path(__file__).resolve().parents[1]
DEFAULT_DATA_DIR = BASE_DIR / "data" / "processed"
```

### Margin Calculation Logic

```python
# Core business logic pattern
margen_estimado = ingresos_totales - costo_min_estimado
margen_pct_volumen = margen_estimado / monto_total_anual
gap_pricing_mdr = klap_mdr - competidor_mdr
```

### Streamlit Simulation Features

The app includes **interactive pricing simulation** with delta adjustments:

- MDR adjustments (±1.00 percentage points)
- Fixed fee adjustments (±150 CLP per transaction)
- Real-time margin impact calculation by cluster

## File Structure Notes

- **No build system**: Direct Python execution
- **Data not versioned**: All CSV/Parquet/Excel files in `.gitignore`
- **Dual notebook setup**: `pricing_22_10.ipynb` (main) + `pricing_10_20.ipynb` (exploratory)
- **App isolation**: Streamlit app in `app/` with separate requirements

## Common Tasks

- **Add new features**: Modify feature engineering cells in `pricing_22_10.ipynb`
- **Adjust clustering**: Update KMeans parameters and cluster interpretation logic
- **New dashboard views**: Add sections to `streamlit_app.py` main() function
- **Cost model changes**: Update interchange/brand cost data loading and calculation logic

## Integration Points

- **External data sources**: Interchange rates, competitor pricing, brand costs (Excel/CSV)
- **Business rules**: Encoded in action suggestion logic and cluster naming
- **Output consumption**: Streamlit expects specific Parquet schema from notebook
